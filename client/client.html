<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="utf-8">
	<script src="/socket.io/socket.io.js"></script>
	<script>
	var socket, canvas, ctx;
	var userID = 'user' + (Math.floor((Math.random()*1000)) + 1);
	var cDraws = {};

		function init(){
			canvas = document.querySelector('canvas');
			ctx = canvas.getContext("2d");
			socket = io.connect();
			canvas.addEventListener("mouseover", mouseOver, false);
			canvas.addEventListener("mousemove", mouseOver, false);
			canvas.addEventListener("mouseout", mouseOut, false);
			socket.on('clientColorSet', function(serverData){
				console.log(serverData);
				var tempLength = serverData.length - 1;
				var tempOpacityString = serverData.substring(tempLength - 4, tempLength - 1);
				var opacity = parseFloat(tempOpacityString);
				document.querySelector("#wrap").style.backgroundColor = serverData;
			});
			socket.emit('join', userID);
			start(socket);
		}

			function mouseOver(e){
				var clientData = getMousePos(canvas, e);
				socket.emit('clientMouseOnStream', clientData);
			}

			function mouseOut(e){
				socket.emit('clientMouseOffStream');
			}

			function start(socket){
				socket.on('draw', function(data){
					draw(data);
				});
			}

	function draw(data){
		ctx.clearRect(0, 0, canvas.width, canvas.height);

		for(var i = 0; i < data.length; i++){
			var tempCircle = data[i];
			var isUser = false;
			if(data[i].type == "user"){
				isUser = true;
			}
			ctx.save();
			ctx.beginPath();
			ctx.fillStyle = data[i].color;
			if(isUser){
				ctx.strokeStyle = "rgba(255,255,255,0.8)";
				ctx.lineWidth = 3;
			}
			ctx.arc(tempCircle.position.x,
					tempCircle.position.y,
					tempCircle.radius,
					0, Math.PI * 2,
					false);
			ctx.closePath();
			ctx.fill();
			if(isUser){
				ctx.stroke();
			}
			ctx.restore();
		}
	}
	
	function getMousePos(canvas, evt) {
        var rect = canvas.getBoundingClientRect();
        return {
          x: evt.clientX - rect.left,
          y: evt.clientY - rect.top
        };
      }

	window.onload = init;
	</script>
	<style>
		html,body{
			margin:0;
			background-color: #FFF;
		}
		#wrap{
			position:absolute;
			margin:20px;
			top: 50%; bottom: 0; right: 0; left: 0;
			transform: translateY(-50%);
		}
		canvas{
			position:absolute;
			top: 50%; bottom: 0; right: 0; left: 0;
			transform: translateY(-50%);
			margin-left: auto;
			margin-right: auto;
			background-color: #000;
		}
	</style>
</head>
<body>
	<div id="wrap">
		<canvas id="canvas" width="750" height="500"></canvas>
	</div>
</body>
</html>
